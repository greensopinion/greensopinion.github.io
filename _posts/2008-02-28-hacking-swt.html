---
layout: post
title: Hacking SWT
date: '2008-02-28T14:04:00.000-08:00'
author: David Green
tags:
modified_time: '2008-02-29T09:10:35.348-08:00'
blogger_id: tag:blogger.com,1999:blog-1482979278030787271.post-1040862986618999275
x_original_url: http://greensopinion.blogspot.com/2008/02/hacking-swt.html
comments: true
---

Talking to Mik at <a href="http://www.tasktop.com/">Tasktop</a> about what it will take to bring his revolutionary <a href="http://www.eclipse.org/mylyn">Mylyn</a>-based product to the mac platform, Mik pointed me to an issue with the way the Safari-based <a href="http://www.eclipse.org/swt">SWT</a> browser widget accesses GMail.  Though Safari is a supported browser for GMail, the embedded Safari browser in <a href="http://www.eclipse.org/">eclipse</a> is not recognized by GMail.  This post highlights the ups-and-downs of my investigation into <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=220836">this issue</a>.<br /><br />Others at Tasktop had discovered that the SWT browser works if gmail is accessed via the http://mail.google.com/mail/?nocheckbrowser URL, which was promising.  This lead me to believe that the user-agent header of an embedded Safari was different than that produced by Safari launched from the desktop.  A quick test browsing to http://whatsmyuseragent.com proved my suspicions were correct.<div><br /></div><div>Here were the user-agent headers:</div><div><br /></div><div>Safari Inside Eclipse: <code>Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en) AppleWebKit/523.12.2 (KHTML, like Gecko)</code></div><div>Stand-alone Safari: <code>Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en) AppleWebKit/523.12.2 (KHTML, like Gecko) Version/3.0.4 Safari/523.12.2</code></div><div><br /><br />The next step then was to see if Safari provides an API for changing the user-agent header.  Having already installed <a href="http://developer.apple.com/tools/xcode/">XCode</a> on my system, it was easy to search the API documentation.  I found a section called 'Spoofing', which is specifically about an API for modifying the 'user-agent' header:<ul>  <li>setCustomUserAgent</li><li>setApplicationNameForUserAgent</li></ul>By the looks of the difference in user-agent headers, the second one was exactly what I was looking for.</div><div><br /></div><div><br />Knowing that SWT involves native calls to Cocoa, I was a little wary about the next step.  Looking at <code>Safari.java</code> I could see in the <code>create()</code> method other calls to the Safari web view to configure various properties.  All of them were performed using JNI native calls, one of the various <code>Cocoa.objc_msgSend</code> variants.  Unfortunately, there wasn't one with the signature that I needed.  The one that I needed would look like this:<br /></div><br /><pre><code><br />public static final native int objc_msgSend(int object, int selector, String string);<br /></code></pre>I added the method to Cocoa.java, and added a call to it in <code>Safari.create()</code> as follows:<br /><pre><code><br />// [webView setApplicationNameForUserAgent:];<br />Cocoa.objc_msgSend(webView, Cocoa.S_setApplicationNameForUserAgent,"Safari/unknown");<br /></code></pre><br /><br /><div><br /> The next step is to provide the native implementation of the method.<br /><div><br /></div><div>Using the eclipse search command, I could see that the other objc_msgSend implementations were in cocoa.c  Never having done JNI before, it was time to do a little looking around.  The <a href="http://www.eclipse.org/swt/faq.php">SWT FAQ</a> had most of what I needed, indicating how to build the native libraries, etc.  The tricky parts were as follows:<div><ul><li>how to determine the mangled function name for the native method?</li><li>now to convert the jstring argument to an NSString?</li></ul><div>For the first issue, a little guessing and a look at the<a href="http://java.sun.com/j2se/1.5.0/docs/guide/jni/spec/design.html"> JNI spec where it talks about mangling</a> and I got it mostly right.  Stubbing out the method, building it (according to the instructions in the SWT FAQ) and I got a <code>java.lang.UnsatisfiedLinkError</code>.  Running it again in the debugger, I was able to see the method name it was looking for and fixed up the name of the method in <code>cocoa.c</code>.  Rebuild, re-run, and so far so good!  My stubbed out method was being called whenever a new SWT Browser control is created.  This is what I had so far:</div><br /><pre><code><br />#ifndef NO_objc_1msgSend__IILjava_lang_String_2<br />JNIEXPORT jint JNICALL Cocoa_NATIVE(objc_1msgSend__IILjava_lang_String_2)<br />(JNIEnv *env, jclass that, jint arg0, jint arg1, jstring arg3)<br />{<br />jint rc = 0;<br />return rc;<br />}<br />#endif<br /></code></pre><br /><div><br /></div><div>So now on to the method implementation: how to call the right method?  A quick google on jstring to NSString resulted in the following:</div><div><br /></div><br /><pre><code><br />#ifndef NO_objc_1msgSend__IILjava_lang_String_2<br />JNIEXPORT jint JNICALL Cocoa_NATIVE(objc_1msgSend__IILjava_lang_String_2)<br />(JNIEnv *env, jclass that, jint arg0, jint arg1, jstring arg3)<br />{<br />jint rc = 0;<br /><br />Cocoa_NATIVE_ENTER(env, that, objc_1msgSend__IILjava_lang_String_2I_FUNC);<br />const char *str = (*env)->GetStringUTFChars(env, arg3, 0);<br /><br />/* use NSString as follows: [NSString stringWithCString: str] */<br /><br />(*env)->ReleaseStringUTFChars(env, arg3, str);<br />Cocoa_NATIVE_EXIT(env, that, objc_1msgSend__IILjava_lang_String_2I_FUNC);<br />return rc;<br />}<br />#endif<br /></code></pre>Okay, so now all I had to do is actually send the Objective-C message to the object!  Copying from other examples in the same file, here's what it I ended up with:</div><br /><pre><code><br />#ifndef NO_objc_1msgSend__IILjava_lang_String_2<br />JNIEXPORT jint JNICALL Cocoa_NATIVE(objc_1msgSend__IILjava_lang_String_2)<br />(JNIEnv *env, jclass that, jint arg0, jint arg1, jstring arg3)<br />{<br />jint rc = 0;<br /><br />Cocoa_NATIVE_ENTER(env, that, objc_1msgSend__IILjava_lang_String_2I_FUNC);<br />const char *str = (*env)->GetStringUTFChars(env, arg3, 0);<br /><br />rc = (jint)objc_msgSend((id)arg0, (SEL)arg1, [NSString stringWithCString: str]);<br />(*env)->ReleaseStringUTFChars(env, arg3, str);<br />Cocoa_NATIVE_EXIT(env, that, objc_1msgSend__IILjava_lang_String_2I_FUNC);<br />return rc;<br />}<br />#endif<br /></code></pre><br /><div><br />I rebuilt the native libraries, re-ran eclipse, and voila!! It worked!  The SWT Safari browser widget was now sending a user-agent string as follows:</div><div><br /></div><div><code>Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en) AppleWebKit/523.12.2 (KHTML, like Gecko) Safari/unknown</code><br /></div><div><br /></div><div>I browsed back to GMail with this new patch, and GMail now recognized Safari embedded in eclipse as a supported browser.  For my first foray into hacking SWT, using JNI and Objective-C, it was a great success.... now if only the SWT team will accept my patch ;)</div><div><br /></div><div><span class="Apple-style-span" style="color: rgb(153, 0, 0);"><span class="Apple-style-span" style="font-style: italic;">updated Feb 29:</span> </span>the fix was committed by the SWT team: see <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=220836">https://bugs.eclipse.org/bugs/show_bug.cgi?id=220836</a> for details</div></div></div>
