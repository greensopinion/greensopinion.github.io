---
layout: post
title: A Tough Lesson in AJAX, JSF and Client-Side State
date: '2009-04-13T14:30:00.000-07:00'
author: David Green
tags:
- JSF
- RichFaces
- AJAX
modified_time: '2009-04-13T14:47:37.917-07:00'
thumbnail: http://3.bp.blogspot.com/_vw9l2nnub6c/SeOS5k1DI1I/AAAAAAAAAFQ/UzzgRhlQMAE/s72-c/Picture+2.png
blogger_id: tag:blogger.com,1999:blog-1482979278030787271.post-2335721230258962248
x_original_url: http://greensopinion.blogspot.com/2009/04/tough-lesson-in-ajax-jsf-and-client.html
comments: true
---

<p>Last week I learned a tough lesson in AJAX, JSF and client-side component state. This one had me fooled for the better part of a day, in part due to the complexity of debugging multiple related AJAX requests, intermittent symptoms, and the opaque nature of JSF component state. Here's what happened:</p><p>The page that was problematic has multiple tabs (rich:tab), some combo boxes (h:selectOneMenu), and at least one suggest control (rich:suggestionbox). The tabs are server-side AJAX tabs. The suggest control also uses AJAX.</p><p>To reproduce the problem, the user takes the following steps:</p><ol><li>Use a suggest control to select a value on the first tab of a<br />multi-tab form <a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_vw9l2nnub6c/SeOS5k1DI1I/AAAAAAAAAFQ/UzzgRhlQMAE/s1600-h/Picture+2.png"><img style="display: block; margin: 0px auto 10px; text-align: center; cursor: pointer; cursor: hand; width: 212px; height: 235px;" src="/images/blog/2009-04-13/picture_2.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5324260702318437202" /></a></li><li>Switch tabs to a different part of the form <a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://2.bp.blogspot.com/_vw9l2nnub6c/SeOTdexL78I/AAAAAAAAAFY/r4kEqtbAc_Y/s1600-h/Picture+4.png"><img style="display: block; margin: 0px auto 10px; text-align: center; cursor: pointer; cursor: hand; width: 400px; height: 34px;" src="/images/blog/2009-04-13/picture_4.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5324261319166914498" /></a></li><li>Press a button on the form in the 2nd tab</li><br /></ol><p>At this point the application complains with validation errors on the first tab. The experience is very confusing to the user: after switching tabs successfully with no errors, pressing a button on the second tab causes validation errors on the first tab. This should never happen in the application: validation is designed to occur only for components that are submitted. When the button is pressed on the second tab, validation should not occur for components in the first tab. So what's going on?</p><p>Here's what I expected to happen:</p><ol><li>The AJAX suggest control sends requests and renders itself</li><li>The tab sends requests and renders its contents</li><li>The button submits the form to make a request</li><br /></ol><p>Here's what really happened, depending on timing of the requests:</p><p><a href="http://picasaweb.google.ca/lh/photo/66hrk6qNPbvKUL2Yx9se3Q?authkey=Gv1sRgCJqn9bqIucagtQE&amp;feat=embedwebsite"><img src="/images/blog/2009-04-13/ajax_sequence.png" width="600" /></a><br /></p><ol><li>The AJAX suggest control sends a request</li><li>The tab sends a request</li><li>The browser receives the response from the tab click and re-renders the tab and its form controls</li><li>The browser receives the response from the suggest control</li></ol><p>After receiving every response the DOM is updated to contain the new JSF component state (remember: we're using client-side component state, so all JSF component state is stored in a hidden form parameter in the browser).</p><p>Due to out-of-order responses, the component state was being set to that of the first tab by the suggest control -- thus the application thinks that the current tab is the first, not the second as we would expect. Pressing the button on the second tab results in the application interpreting the submitted form as submitting values for components on the first tab. This is problematic for HTML &lt;select&gt; controls, since HTTP parameters are not submitted for &lt;select&gt; controls where no value is selected.</p><p>So how do we fix this problem? Have all AJAX controls use the same request queue. This is achieved by setting the attribute <code>eventsQueue="myApplicationEventQueue"</code> on all of the richfaces AJAX controls. By doing so we end up with the following sequence:</p><p><a href="http://picasaweb.google.ca/lh/photo/as_qhL59U5EmorC-r6doWw?authkey=Gv1sRgCJqn9bqIucagtQE&amp;feat=embedwebsite"><img src="/images/blog/2009-04-13/ajax_sequence2.png"  width="600" /></a><br /></p><p>Lesson learned: AJAX requests update JSF component state on the client, and thus must all complete in sequence.  Otherwise component state on the client can get out of sync with what we expect it to be.</p>
