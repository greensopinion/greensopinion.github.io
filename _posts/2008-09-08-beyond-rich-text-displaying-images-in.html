---
layout: imported-post
title: 'Beyond Rich Text (Part 2): Displaying Images in an SWT StyledText'
date: '2008-09-08T19:56:00.000-07:00'
author: David Green
tags: 
modified_time: '2008-09-08T20:41:11.977-07:00'
thumbnail: http://4.bp.blogspot.com/_vw9l2nnub6c/SMXsxvUqowI/AAAAAAAAAB4/cDv0Q6j3VXc/s72-c/Picture+1.png
blogger_id: tag:blogger.com,1999:blog-1482979278030787271.post-3122533636292453770
blogger_orig_url: http://greensopinion.blogspot.com/2008/09/beyond-rich-text-displaying-images-in.html
---

Recently <a href="http://greensopinion.blogspot.com/2008/09/beyond-rich-text-tricks-using.html">I wrote about a few simple tricks</a> that make it possible to display more than just text in a StyledText widget.  In this article I take it a step further: displaying images in an SWT StyledText widget.<div><br /></div><div>Normally a StyledText widget cannot display images.  Why would you want to display images in a text control, you might ask?  Well, there are cases where a rich text control is used to render text which may have embedded images.  Take for example the <a href="http://www.eclipse.org/mylyn">Mylyn</a> task editor.  It displays bug descriptions and comments.  In some repositories (such as Trac or JIRA) it's possible to use markup to display rich text and images.  It's common to see screenshots or other visual data included in bug reports.</div><div><br /></div><div>To display images in a StyledText we use a small variation on the tricks from <a href="http://greensopinion.blogspot.com/2008/09/beyond-rich-text-tricks-using.html">my previous post</a>.  Previously I used an annotation to mark the location of the thing I wanted to draw, and a painter to paint it.  This approach works well when we know the size of the thing we're about to draw (such as a character or horizontal rule).  In the case of images, it gets more complicated.  We need to know the size of the image so that we can create enough space for it in the text.  </div><div><br /></div><div>Since loading image data can be slow (over a network or from a busy disk) we must load the image asynchronously and render it when it becomes available.  We can get away with it since users are used to this experience -- that's how web browsers work.</div><div><br /></div><div>So here's a run-down of the technique I used:</div><div><ol><li>Mark the location of the image with an annotation</li><li>Asynchronously download the image</li><li>When the image becomes available, determine its height (in pixels)</li><li>Determine the font in use at the annotated location</li><li>Using font metrics compute the number of blank lines required to create enough vertical space (in pixels) to display the image without obscuring text</li><li>Insert the required number of newlines into the text widget</li><li>Adjust text presentation offsets (some styled regions may need to be translated by the same number of characters as we inserted in the previous step)</li><li>Associate the image data with the annotation so that the painter will have access to it</li><li>Cause the text widget to repaint</li><li>Use the custom painter to paint the image in the empty space that we created</li></ol>Here's a screenshot demonstrating this technique in action:</div><div><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://4.bp.blogspot.com/_vw9l2nnub6c/SMXsxvUqowI/AAAAAAAAAB4/cDv0Q6j3VXc/s1600-h/Picture+1.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;" src="http://4.bp.blogspot.com/_vw9l2nnub6c/SMXsxvUqowI/AAAAAAAAAB4/cDv0Q6j3VXc/s400/Picture+1.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5243857680403702530" /></a>It works!  The SWT StyledText can now display images!</div><div><br /></div><div>Though the result is pleasing, there remain a few issues with this approach:</div><div><ul><li>Images don't flow with the text, that is we can't wrap text around the image on the left or right side, only above and below.</li><li>Images aren't included in clipboard operations such as copy and paste.</li></ul><div>If you're interested in the code involved in this technique <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=246034">you can find it here</a>.</div><div><br /></div><div>The fact that we can do this using standard JFace and SWT APIs is a testament to the quality and completeness of the platform.  Thanks Eclipse!</div></div>